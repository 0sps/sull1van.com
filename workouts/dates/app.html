<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dating Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #1a1a1d;
            --accent-primary: #ff3d00;
            --accent-secondary: #ff6d3d;
            --accent-success: #00ff88;
            --accent-warning: #ffbb00;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b5;
            --text-muted: #606065;
            --border: #2a2a2d;
            --gradient-fire: linear-gradient(135deg, #ff3d00 0%, #ff6d3d 50%, #ffbb00 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 3px;
            background: var(--gradient-fire);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            background: var(--accent-primary);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .btn-danger {
            background: #ff0033;
        }

        .btn-danger:hover {
            background: #cc0029;
        }

        .people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 100px;
        }

        .person-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .person-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .person-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-secondary);
            margin-bottom: 5px;
        }

        .person-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .person-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .person-info {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            color: var(--text-muted);
        }

        .info-value {
            color: var(--text-secondary);
            text-align: right;
        }

        .ratings {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .rating-item {
            text-align: center;
        }

        .rating-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .rating-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            max-width: 800px;
            width: 100%;
            margin: 40px auto;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
            color: var(--accent-secondary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--accent-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 0.9rem;
            color: var(--accent-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input,
        select,
        textarea {
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .height-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Date History Section */
        .date-history {
            margin-top: 30px;
        }

        .date-entry {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 15px;
        }

        .date-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .date-entry-date {
            color: var(--accent-secondary);
            font-weight: 700;
        }

        .add-date-btn {
            margin-top: 15px;
            width: 100%;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        /* Combobox styling */
        .combobox-wrapper {
            position: relative;
        }

        .combobox-input {
            width: 100%;
        }

        .combobox-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--accent-primary);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }

        .combobox-dropdown.show {
            display: block;
        }

        .combobox-option {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .combobox-option:hover {
            background: var(--bg-secondary);
        }

        .combobox-option.selected {
            background: var(--bg-tertiary);
            color: var(--accent-secondary);
        }

        @media (max-width: 768px) {
            .people-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .ratings {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="logo">DATING TRACKER</h1>
        <div class="header-actions">
            <button class="btn" onclick="addNewPersonInline()">+ Add Person</button>
            <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
        </div>
    </div>

    <div id="peopleContainer" class="people-grid">
        <!-- People cards will be inserted here -->
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ü§î</div>
        <div class="empty-state-text">No entries yet</div>
        <button class="btn" onclick="openAddModal()">Add Your First Person</button>
    </div>

    <!-- Add/Edit Modal -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Person</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="personForm">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <div class="section-title">Basic Info</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="name">Name *</label>
                                <input type="text" id="name" required>
                            </div>
                            <div class="form-group">
                                <label for="birthdate">Birthdate</label>
                                <input type="date" id="birthdate">
                            </div>
                            <div class="form-group">
                                <label>Height</label>
                                <div class="height-inputs">
                                    <input type="number" id="heightFeet" placeholder="Feet" min="0" max="8">
                                    <input type="number" id="heightInches" placeholder="Inches" min="0" max="11">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="occupation">Occupation</label>
                                <input type="text" id="occupation">
                            </div>
                            <div class="form-group">
                                <label for="dateWeMet">Date We Met *</label>
                                <input type="date" id="dateWeMet" required>
                            </div>
                            <div class="form-group">
                                <label for="howWeMet">How We Met</label>
                                <select id="howWeMet">
                                    <option value="">Select...</option>
                                    <option value="Hinge">Hinge</option>
                                    <option value="Bumble">Bumble</option>
                                    <option value="Tinder">Tinder</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="Through Friends">Through Friends</option>
                                    <option value="Bar/Club">Bar/Club</option>
                                    <option value="Work">Work</option>
                                    <option value="School">School</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="location">Their Location</label>
                                <input type="text" id="location">
                            </div>
                            <div class="form-group">
                                <label for="snapchat">Snapchat</label>
                                <input type="text" id="snapchat">
                            </div>
                            <div class="form-group">
                                <label for="instagram">Instagram</label>
                                <input type="text" id="instagram">
                            </div>
                        </div>
                    </div>

                    <!-- Ratings -->
                    <div class="form-section">
                        <div class="section-title">Ratings (1-10)</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="ratingFace">Face</label>
                                <input type="number" id="ratingFace" min="1" max="10" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="ratingBody">Body</label>
                                <input type="number" id="ratingBody" min="1" max="10" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="ratingKissing">Kissing</label>
                                <input type="number" id="ratingKissing" min="1" max="10" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="ratingVibe">Conversation/Vibe</label>
                                <input type="number" id="ratingVibe" min="1" max="10" step="0.5">
                            </div>
                        </div>
                    </div>

                    <!-- Relationship Info -->
                    <div class="form-section">
                        <div class="section-title">Relationship Info</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="numberOfDates">Number of Dates</label>
                                <input type="number" id="numberOfDates" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="lastContactDate">Last Contact Date</label>
                                <input type="date" id="lastContactDate">
                            </div>
                            <div class="form-group">
                                <label for="relationshipStatus">Relationship Status</label>
                                <div class="combobox-wrapper">
                                    <input type="text" id="relationshipStatus" class="combobox-input"
                                        placeholder="Type or select...">
                                    <div id="relationshipStatusDropdown" class="combobox-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="interestLevel">Interest Level</label>
                                <div class="combobox-wrapper">
                                    <input type="text" id="interestLevel" class="combobox-input"
                                        placeholder="Type or select...">
                                    <div id="interestLevelDropdown" class="combobox-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="sharedInterests">Shared Interests</label>
                                <textarea id="sharedInterests"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Date History -->
                    <div class="form-section date-history">
                        <div class="section-title">Date History</div>
                        <div id="dateHistoryContainer">
                            <!-- Date entries will be inserted here -->
                        </div>
                        <button type="button" class="btn add-date-btn" onclick="addDateEntry()">+ Add Date</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deletePerson()"
                    style="display: none; margin-right: auto;">Delete</button>
                <button type="button" class="btn" onclick="savePerson()">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8uvGCSb3-stSl0ECOeo-Hl1emIRcx2CM",
            authDomain: "dates-cfeb5.firebaseapp.com",
            projectId: "dates-cfeb5",
            storageBucket: "dates-cfeb5.firebasestorage.app",
            messagingSenderId: "932967099991",
            appId: "1:932967099991:web:11afdf5dbc03c1e8cafd12"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ALLOWED_EMAIL = "sspsful@gmail.com";
        const COLLECTION_NAME = "Dates";

        let currentEditId = null;
        let allPeople = [];
        let isCreatingInline = false;

        // Check auth
        onAuthStateChanged(auth, async (user) => {
            if (!user || user.email !== ALLOWED_EMAIL) {
                window.location.href = 'index.html';
            } else {
                await loadPeople();
            }
        });

        // Load all people
        async function loadPeople() {
            try {
                const querySnapshot = await getDocs(collection(db, COLLECTION_NAME));
                allPeople = [];
                querySnapshot.forEach((doc) => {
                    allPeople.push({ id: doc.id, ...doc.data() });
                });
                // Sort by date we met descending
                allPeople.sort((a, b) => {
                    const dateA = a.dateWeMet?.seconds || 0;
                    const dateB = b.dateWeMet?.seconds || 0;
                    return dateB - dateA;
                });
                renderPeople();
            } catch (error) {
                console.error('Error loading people:', error);
            }
        }

        // Render people cards
        function renderPeople() {
            const container = document.getElementById('peopleContainer');
            const emptyState = document.getElementById('emptyState');

            if (allPeople.length === 0 && !isCreatingInline) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            let html = '';

            // If we are creating inline, add the placeholder card
            if (isCreatingInline) {
                html += `
                    <div class="person-card" style="border-color: var(--accent-primary); cursor: default;">
                        <div class="person-header">
                            <div style="width: 100%;">
                                <input type="text" id="inlineNewName" placeholder="Enter name..." 
                                    style="width: 100%; font-size: 1.3rem; font-weight: 700; color: var(--accent-secondary); background: transparent; border: none; border-bottom: 2px solid var(--accent-primary); padding: 5px 0;"
                                    onkeydown="if(event.key === 'Enter') saveInlinePerson()"
                                    onblur="cancelInlineIfEmpty()">
                                <div class="person-status">Typing...</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" style="padding: 5px 10px; font-size: 0.7rem;" onclick="saveInlinePerson()">Save</button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.7rem;" onclick="cancelInline()">Cancel</button>
                        </div>
                    </div>
                `;
            }

            html += allPeople.map(person => {
                const dateWeMet = person.dateWeMet ? new Date(person.dateWeMet.seconds * 1000).toLocaleDateString() : 'N/A';
                const age = person.birthdate ? calculateAge(new Date(person.birthdate.seconds * 1000)) : 'N/A';
                const height = person.height ? `${person.height.feet || 0}'${person.height.inches || 0}"` : 'N/A';

                return `
                    <div class="person-card">
                        <div class="person-header">
                            <div>
                                <div class="person-name">${person.name}</div>
                                <div class="person-status">${person.relationshipStatus || 'No status'}</div>
                            </div>
                            <div class="person-actions">
                                <button class="icon-btn" onclick="openEditModal('${person.id}')">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="person-info">
                            <div class="info-row">
                                <span class="info-label">Met:</span>
                                <span class="info-value">${dateWeMet}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Age:</span>
                                <span class="info-value">${age}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Height:</span>
                                <span class="info-value">${height}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Dates:</span>
                                <span class="info-value">${person.numberOfDates || 0}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Interest:</span>
                                <span class="info-value">${person.interestLevel || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="ratings">
                            <div class="rating-item">
                                <div class="rating-label">Face</div>
                                <div class="rating-value">${person.ratings?.face || '-'}</div>
                            </div>
                            <div class="rating-item">
                                <div class="rating-label">Body</div>
                                <div class="rating-value">${person.ratings?.body || '-'}</div>
                            </div>
                            <div class="rating-item">
                                <div class="rating-label">Kiss</div>
                                <div class="rating-value">${person.ratings?.kissing || '-'}</div>
                            </div>
                            <div class="rating-item">
                                <div class="rating-label">Vibe</div>
                                <div class="rating-value">${person.ratings?.conversationVibe || '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            if (isCreatingInline) {
                document.getElementById('inlineNewName').focus();
            }
        }

        function calculateAge(birthdate) {
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }
            return age;
        }

        // Modal functions
        window.addNewPersonInline = function () {
            isCreatingInline = true;
            renderPeople();
        };

        window.cancelInline = function () {
            isCreatingInline = false;
            renderPeople();
        };

        window.cancelInlineIfEmpty = function () {
            const name = document.getElementById('inlineNewName').value.trim();
            if (!name) {
                cancelInline();
            }
        };

        window.saveInlinePerson = async function () {
            const name = document.getElementById('inlineNewName').value.trim();
            if (!name) {
                cancelInline();
                return;
            }

            const personData = {
                name,
                dateWeMet: Timestamp.now(),
                numberOfDates: 0,
                ratings: {
                    face: 0,
                    body: 0,
                    kissing: 0,
                    conversationVibe: 0
                }
            };

            try {
                await addDoc(collection(db, COLLECTION_NAME), personData);
                isCreatingInline = false;
                await loadPeople();
            } catch (error) {
                console.error('Error adding person inline:', error);
                alert('Error adding person.');
            }
        };

        window.openAddModal = function () {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add Person';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('personForm').reset();
            // Pre-fill today's date
            document.getElementById('dateWeMet').value = new Date().toISOString().split('T')[0];
            document.getElementById('dateHistoryContainer').innerHTML = '';
            document.getElementById('personModal').classList.add('show');
            setupComboboxes();
        };

        window.openEditModal = function (id) {
            currentEditId = id;
            const person = allPeople.find(p => p.id === id);
            if (!person) return;

            document.getElementById('modalTitle').textContent = 'Edit Person';
            document.getElementById('deleteBtn').style.display = 'block';

            // Fill basic info
            document.getElementById('name').value = person.name || '';
            document.getElementById('birthdate').value = person.birthdate ? new Date(person.birthdate.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('heightFeet').value = person.height?.feet || '';
            document.getElementById('heightInches').value = person.height?.inches || '';
            document.getElementById('occupation').value = person.occupation || '';
            document.getElementById('dateWeMet').value = person.dateWeMet ? new Date(person.dateWeMet.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('howWeMet').value = person.howWeMet || '';
            document.getElementById('location').value = person.location || '';
            document.getElementById('snapchat').value = person.snapchat || '';
            document.getElementById('instagram').value = person.instagram || '';

            // Fill ratings
            document.getElementById('ratingFace').value = person.ratings?.face || '';
            document.getElementById('ratingBody').value = person.ratings?.body || '';
            document.getElementById('ratingKissing').value = person.ratings?.kissing || '';
            document.getElementById('ratingVibe').value = person.ratings?.conversationVibe || '';

            // Fill relationship info
            document.getElementById('numberOfDates').value = person.numberOfDates || 0;
            document.getElementById('lastContactDate').value = person.lastContactDate ? new Date(person.lastContactDate.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('relationshipStatus').value = person.relationshipStatus || '';
            document.getElementById('interestLevel').value = person.interestLevel || '';
            document.getElementById('sharedInterests').value = person.sharedInterests || '';

            // Fill date history
            const dateHistoryContainer = document.getElementById('dateHistoryContainer');
            dateHistoryContainer.innerHTML = '';
            if (person.dateHistory && person.dateHistory.length > 0) {
                person.dateHistory.forEach((date, index) => {
                    addDateEntry(date, index);
                });
            }

            document.getElementById('personModal').classList.add('show');
            setupComboboxes();
        };

        window.closeModal = function () {
            document.getElementById('personModal').classList.remove('show');
            currentEditId = null;
        };

        // Date entry management
        window.addDateEntry = function (dateData = null, index = null) {
            const container = document.getElementById('dateHistoryContainer');
            const entryIndex = index !== null ? index : container.children.length;

            const dateEntry = document.createElement('div');
            dateEntry.className = 'date-entry';
            dateEntry.innerHTML = `
                <div class="date-entry-header">
                    <span class="date-entry-date">Date #${entryIndex + 1}</span>
                    <button type="button" class="icon-btn" onclick="removeDateEntry(this)">üóëÔ∏è</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="date-timestamp" value="${dateData?.dateTimestamp ? new Date(dateData.dateTimestamp.seconds * 1000).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Location/Venue</label>
                        <input type="text" class="date-location" value="${dateData?.location || ''}">
                    </div>
                    <div class="form-group">
                        <label>Activity</label>
                        <input type="text" class="date-activity" value="${dateData?.activity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Cost ($)</label>
                        <input type="number" class="date-cost" min="0" step="0.01" value="${dateData?.cost || ''}">
                    </div>
                    <div class="form-group">
                        <label>Rating (1-10)</label>
                        <input type="number" class="date-rating" min="1" max="10" step="0.5" value="${dateData?.rating || ''}">
                    </div>
                    <div class="form-group full-width">
                        <label>Notes</label>
                        <textarea class="date-notes">${dateData?.notes || ''}</textarea>
                    </div>
                </div>
            `;
            container.appendChild(dateEntry);
        };

        window.removeDateEntry = function (btn) {
            btn.closest('.date-entry').remove();
            // Re-number remaining entries
            const entries = document.querySelectorAll('.date-entry');
            entries.forEach((entry, index) => {
                entry.querySelector('.date-entry-date').textContent = `Date #${index + 1}`;
            });
        };

        // Save person
        window.savePerson = async function () {
            const saveBtn = event?.target?.closest('button') || document.querySelector("button[onclick='savePerson()']");
            const originalBtnText = saveBtn ? saveBtn.textContent : 'Save';

            console.log('Save triggered...');
            const nameEl = document.getElementById('name');
            const dateWeMetEl = document.getElementById('dateWeMet');

            if (!nameEl || !dateWeMetEl) {
                console.error('Critical elements missing from DOM');
                return;
            }

            const name = nameEl.value.trim();
            const dateWeMetVal = dateWeMetEl.value;

            if (!name || !dateWeMetVal) {
                alert('Name and Date We Met are required!');
                return;
            }

            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }

            // Helper for safe date to timestamp conversion
            const toTimestamp = (dateStr) => {
                if (!dateStr) return null;
                try {
                    // Use midday to avoid timezone shifting issues with YYYY-MM-DD
                    const d = new Date(dateStr + 'T12:00:00');
                    if (isNaN(d.getTime())) return null;
                    return Timestamp.fromDate(d);
                } catch (e) {
                    console.warn('Date parsing failed for:', dateStr, e);
                    return null;
                }
            };

            // Collect date history
            const dateHistory = [];
            document.querySelectorAll('.date-entry').forEach(entry => {
                const tsVal = entry.querySelector('.date-timestamp').value;
                const timestamp = toTimestamp(tsVal) || Timestamp.now();

                dateHistory.push({
                    dateTimestamp: timestamp,
                    location: (entry.querySelector('.date-location')?.value || '').trim(),
                    activity: (entry.querySelector('.date-activity')?.value || '').trim(),
                    cost: parseFloat(entry.querySelector('.date-cost')?.value) || 0,
                    rating: parseFloat(entry.querySelector('.date-rating')?.value) || 0,
                    notes: (entry.querySelector('.date-notes')?.value || '').trim()
                });
            });

            const personData = {
                name,
                dateWeMet: toTimestamp(dateWeMetVal) || Timestamp.now(),
                birthdate: toTimestamp(document.getElementById('birthdate').value),
                height: {
                    feet: parseInt(document.getElementById('heightFeet').value) || 0,
                    inches: parseInt(document.getElementById('heightInches').value) || 0
                },
                occupation: (document.getElementById('occupation').value || '').trim(),
                howWeMet: document.getElementById('howWeMet').value || '',
                location: (document.getElementById('location').value || '').trim(),
                snapchat: (document.getElementById('snapchat').value || '').trim(),
                instagram: (document.getElementById('instagram').value || '').trim(),
                ratings: {
                    face: parseFloat(document.getElementById('ratingFace').value) || 0,
                    body: parseFloat(document.getElementById('ratingBody').value) || 0,
                    kissing: parseFloat(document.getElementById('ratingKissing').value) || 0,
                    conversationVibe: parseFloat(document.getElementById('ratingVibe').value) || 0
                },
                numberOfDates: parseInt(document.getElementById('numberOfDates').value) || 0,
                lastContactDate: toTimestamp(document.getElementById('lastContactDate').value),
                relationshipStatus: document.getElementById('relationshipStatus').value || '',
                interestLevel: document.getElementById('interestLevel').value || '',
                sharedInterests: (document.getElementById('sharedInterests').value || '').trim(),
                dateHistory
            };

            console.log('Saving person data:', personData);

            try {
                if (currentEditId) {
                    await updateDoc(doc(db, COLLECTION_NAME, currentEditId), personData);
                    console.log('Update successful');
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), personData);
                    console.log('Add successful');
                }
                closeModal();
                await loadPeople();
            } catch (error) {
                console.error('Firestore Error:', error);
                alert('DATABASE ERROR (' + error.code + '): ' + error.message);
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalBtnText;
                }
            }
        };

        // Delete person
        window.deletePerson = async function () {
            if (!currentEditId) return;
            if (!confirm('Are you sure you want to delete this person? This cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, COLLECTION_NAME, currentEditId));
                closeModal();
                await loadPeople();
            } catch (error) {
                console.error('Error deleting person:', error);
                alert('Error deleting person. Please try again.');
            }
        };

        // Sign out
        window.signOut = async function () {
            await auth.signOut();
            window.location.href = 'index.html';
        };

        // Combobox functionality
        function setupComboboxes() {
            setupCombobox('relationshipStatus', [
                'Talking',
                'Dating',
                'Ended',
                'Turned them down',
                'Friendzoned them',
                'Friendzoned me',
                'Ghosted me',
                'Broke up with them',
                'Broke up with me'
            ], 'relationshipStatus');

            setupCombobox('interestLevel', [
                'VERY Interested'
            ], 'interestLevel');
        }

        function setupCombobox(inputId, defaultOptions, fieldName) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(inputId + 'Dropdown');

            // Get unique values from existing data
            const existingValues = new Set(defaultOptions);
            allPeople.forEach(person => {
                if (person[fieldName]) {
                    existingValues.add(person[fieldName]);
                }
            });

            const options = Array.from(existingValues).sort();

            input.addEventListener('focus', () => {
                showDropdown(input, dropdown, options);
            });

            input.addEventListener('input', () => {
                const filtered = options.filter(opt =>
                    opt.toLowerCase().includes(input.value.toLowerCase())
                );
                showDropdown(input, dropdown, filtered);
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function showDropdown(input, dropdown, options) {
            dropdown.innerHTML = options.map(opt => `
                <div class="combobox-option" onclick="selectComboboxOption('${input.id}', '${opt.replace(/'/g, "\\'")}')">
                    ${opt}
                </div>
            `).join('');
            dropdown.classList.add('show');
        }

        window.selectComboboxOption = function (inputId, value) {
            document.getElementById(inputId).value = value;
            document.getElementById(inputId + 'Dropdown').classList.remove('show');
        };
    </script>
</body>

</html>